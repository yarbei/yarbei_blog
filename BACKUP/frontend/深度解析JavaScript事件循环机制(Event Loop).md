# 深度解析JavaScript事件循环机制(Event Loop)

# 深度解析JavaScript事件循环机制(Event Loop)

---

> JavaScript(以下简称JS)是一门单线程、非阻塞的脚本语言。
>

## JS为什么是单线程？

一个简单的原因就是，js在设计之初只是进行一些简单的表单校验，这完全不需要多线程，单线程完全可以胜任这项工作。即便后来前端发展迅速，承载的能力越来越多，也没有发展到非多线程不可的程度。

更为主要的原因在于，如果js是多线程的，在运行时多个线程同时对DOM元素进行操作，那具体以哪个线程为主就是个问题了，线程的调度问题是一个比较复杂的问题。

在最新的HTML5标准中提出了Web-Worker，允许使用new Worker的方式来开启一个新的线程，去运行一段单独的js文件脚本，但是在这个新线程中严格的要求了可以使用的功能，比如说他只能使用ECMAScript, 不能访问DOM和BOM。这也就限制死了多个线程同时操作DOM元素的可能。

由于JS是单线程，JS任务也只能一个一个按顺序执行，那么问题来了，如果一个任务执行时间过长，我们就要一直等着它吗，显然不是的。

## 同步｜异步

JS分为同步任务和异步任务：

- **同步任务：** 立即执行的任务队列，比如一个简单的函数；
- **异步任务：** 请求接口发送 ajax，发送 promise，或时间计时器等等；

1. 浏览器线程先执行同步任务，途中遇到异步任务就将其加入到等待任务队列中去，然后继续向下执行
2. 等同步任务全部执行完毕后，再去等待任务队列中去将所有可执行的微任务逐个执行
3. 执行完微任务后在拿取第一个先到达执行条件的宏任务来执行
4. 执行完后再去等待任务队列中清理执行完所有已到达执行条件的微任务
5. 然后再拿取下一个宏任务来执行，如果宏任务执行产生微任务或者微任务执行产生宏任务就一样加入到等待任务队列中，然后还是按照主线程每次到等待队列中先执行完所以的微任务再逐个执行宏任务的顺序来走

**异步任务都是谁先到达条件谁先执行，但是谁先到达执行条件也有优先级的问题，这个优先级要看这个任务是宏任务还是微任务；微任务的优先级比宏任务的要高；**

## 宏任务｜微任务

- **宏任务：**(macro)task，可以理解是每次执行栈执行的代码就是一个宏任务（包括每次从事件队列中获取一个事件回调并放到执行栈中执行）。

浏览器为了能够使得JS内部(macro)task与DOM任务能够有序的执行，会在一个(macro)task执行结束后，在下一个(macro)task 执行开始前，对页面进行重新渲染，流程如下：

(macro)task->渲染->(macro)task->...

- **微任务：** microtask,可以理解是在当前 task 执行结束后立即执行的任务。也就是说，在当前task任务后，下一个task之前，在渲染之前。

所以它的响应速度相比setTimeout（setTimeout是task）会更快，因为无需等渲染。也就是说，在某一个macrotask执行完后，就会将在它执行期间产生的所有microtask都执行完毕（在渲染前）。

微任务 优先于 宏任务 执行，所以如果有需要优先执行的逻辑，放入 微任务 队列会比 宏任务 更早的被执行。

||**宏任务**|**微任务**|
| ----------------------| ------------------------------------------------------------------------------------------------------------------------| --------------------------------------------------------------------------------------------------------|
|**谁发起的**|宿主（Node，浏览器）|JS引擎|
|**具体事件**|1.script（同步代码）<br>2.setTimout/setInterval<br>3.UI rendering/UI事件<br>4.postMessage<br>5.setImmediate,I/O(Node.js)|1.Promise<br>2.MutaionObserver<br>3.Object.obseve(已废弃；Proxy对象替代）<br>4.process.nextTick(Node.js)|
|**谁先运行**|后运行|先运行|
|**会出发新一轮tick吗**|会|不会|

同步和异步任务分别进入不同的执行环境， 先执行同步任务，把异步任务放入循环队列当中，等待同步任务执行完，再执行队列中的异步任务。异步任务先执行微观任务，再执行宏观任务。一直这样循环，反复执行，就是我们说的 Event Loop (事件循环)。

事件循环是 JS 这门语言中非常重要且基础的概念。让我们可以清楚的了解事件循环的执行顺序和每一个阶段的特点，可以使我们对一段异步代码的执行顺序有一个清晰的认识，从而减少代码运行的不确定性。合理的使用各种延迟事件的方法，有助于代码更好的按照其优先级去执行。
